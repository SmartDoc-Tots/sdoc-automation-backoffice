# Archivo: .github/workflows/playwright.yml

name: Run Login Test Only

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 8 * * *'  # Todos los d√≠as a las 08:00 UTC
  
  # Ejecuci√≥n Manual desde GitHub Actions
  workflow_dispatch:
    inputs:
      browser:
        description: 'Selecciona el navegador'
        required: true
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Login Test Only
        run: |
          # L√≥gica para seleccionar navegador si es manual, o correr por defecto si es autom√°tico
          PROJECT_FLAG=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.browser }}" != "all" ]; then
            PROJECT_FLAG="--project=${{ inputs.browser }}"
          fi
          
          # Ejecutamos SOLO el test de login
          npx playwright test tests/login.spec.ts $PROJECT_FLAG

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  notify-discord:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: Notify Discord on Success
        if: needs.test.result == 'success'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ‚úÖ **Login Test - EXITOSO**
            
            üéØ **Repo:** ${{ github.repository }}
            üåø **Branch:** ${{ github.ref_name }}
            üë§ **Actor:** ${{ github.actor }}
            
            üìä **Estado:** El login funciona correctamente con las credenciales actuales.
            üîó **Ver detalles:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Notify Discord on Failure (Credentials Issue)
        if: needs.test.result == 'failure'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            üö® **ALERTA: Fallo en Test de Login**
            
            ‚ö†Ô∏è **CAUSA PROBABLE:** Las credenciales han cambiado o expirado.
            
            üéØ **Repo:** ${{ github.repository }}
            üåø **Branch:** ${{ github.ref_name }}
            üë§ **Actor:** ${{ github.actor }}
            
            üõë **Acci√≥n requerida:** Revisar si el usuario/password en TestConfig siguen vigentes.
            üîó **Ver reporte:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Notify Discord on Cancellation
        if: needs.test.result == 'cancelled'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            üîÑ **Login Test - CANCELADO**